# 记录

## Orbslam2数据集调查(TUM数据集)

1. 暂时不需要手动制作TUM格式数据集，已明确所需要的最简输入数据集格式为：**rgb文件夹 & rgb.txt**，其中rgb文件夹中包含以数字时间为名称的png图片(同格式)，rgb.txt则为时间戳和对应时间的rgb图片文件位置，名称和时间需要保持一致。slam系统运行时会调用rgb.txt，实现对时间的记录和时间顺序的图片的调用；
2. 关于TUM数据集，彩色图像以 PNG 格式存储为 640x480 8 位 RGB 图像，深度图以 PNG 格式存储为 640x480 16 位单色图像，文件夹的格式为：depth和rgb文件夹(含深度和rgb图片),depth.txt和rgb.txt对应时间顺序和位置，groundtruth.txt为相机位姿记录文件，文本文件中的每一行都包含一个姿势，每行的格式为 `timestamp tx ty tz qx qy qz qw`，timestamp为时间戳，tx ty tz为相机光学中心对于定义世界原点的位置(坐标)，QX QY QZ QW（4 个浮点数）以单位四元数的形式给出相机光学中心的方向(姿态)，同样相对于世界原点；
3. 关于MVSnet部分的数据集，主要包含对应时间顺序的rgb和深度图片文件夹，camera.txt描述了相机内部参数：第一行为`Pinhole fx fy cx cy 0`，这部分可以直接由slam部分的相机配置文件`TUMX.yaml`决定,首尾都是固定的词语，无实际意义，第二行为输入图片的分辨率，这直接由数据集决定，也为固定数据，scale.txt文件为尺度参数，也为固定数据(基本不变)；
4. 最关键的是MVSnet部分数据集的位姿文件`poses_gt.txt`，每一行数据的格式都为`图片编号(名称) 16个元素的姿态矩阵排列(4*4 SE(3))`，并且都是世界坐标系位姿；
5. 重要的，**需要做的是在slam部分计算得到四元数表示的位姿后，将四元数转换为旋转矩阵，再结合平移向量组合为4*4的变换矩阵**，即可实现位姿数据的传递(写入文件中而非直接传递位姿数据)，另外关于世界坐标系，一般使用第一帧作为世界坐标原点，slam部分为增量计算方式。

## 考虑SLAM部分功能设计

1. 考虑在现有基础上增加两个线程，一个为点云信息处理和显示线程，一个为与深度估计模块通信线程；
2. 点云线程的功能为：接受tracking线程加入的关键帧，对点云信息进行处理和显示；
3. 通信线程的功能为：与深度估计模块进行通信，内容为需要处理的关键帧，新建相应格式数据集，接受处理完的关键帧标志信息；
4. 此外，需要对关键帧新增一个成员变量，表示这个关键帧的图片名称和位置，并在得到关键帧位姿后，增加功能：复制该关键帧与上一个关键帧的名称和位姿数据，导出并设计为相应格式的数据集；将该帧插入点云的关键帧队列；可能关键帧有无深度信息也可以作为成员变量？

## SLAM功能设计更新

1. 在`frame`和`keyframe`的`class`中都增加图片位置的`const string` 类型成员变量，在新建帧时增加写入；
2. 增加一个`contact`的`class`，在新建关键帧时在此变量中增加新的关键帧信息`id`,`address`和`Tcw`(可自行添加),并增加关键帧是否处理的标志`mbvToBeProcss`，已经记录的关键帧数量`mNumsAllKFS`，已经处理的关键帧数量`mNumsKFSProed`，关键帧是否被删除的标志`mbvDeleted`，用于通信线程和建图线程；
3. 增加一个`ContactWithPython`的线程，用于和MVSnet部分进行通信，`while(1)`中循环查询`contact`的`mNumsAllKFS`和`mNumsKFSProed`，顺序执行两部分功能：有未处理的关键帧则新建数据集并发送给MVSnet，查看是否存在`MVSnet`发送的数据并接收；
4. 多线程问题的处理，增加互斥锁在改变`keyframe`（改变`contact`）时，禁止通信线程访问，并结束时允许通信线程访问，这里考虑到通信线程执行效率非常高，在新建关键帧完成后很短时间中就完成通信操作（为了保证效率直接复制数据操作），因此不会影响后续关键帧的操作；
5. 建图线程的大致思路：`while(1)`中循环读取通信线程的数据，进行建图操作，这部分代码由之前考虑的改造即可，参考网络代码；
